# v0.1.0 Implementation Plan: Braille Canvas Foundation

## Overview

Implement the core braille canvas with pixel-level control. This milestone establishes the foundation for all future drawing operations.

## Current State

- Documentation complete (PLAN.md, ROADMAP.md, CLAUDE.md)
- No Go source code exists yet
- Clean repository ready for implementation

## Files to Create (in order)

### 1. `go.mod`

Initialize the Go module:

```
module github.com/cboone/brodot

go 1.21
```

---

### 2. `canvas/braille.go`

Braille encoding constants and helpers.

**Contents:**
- `BrailleOffset` constant (0x2800) - Unicode code point for empty braille pattern
- `pixelMap` - 4x2 array mapping (row, column) to braille dot bits

**Braille dot bit mapping:**
```
Dot positions:     Bit values:
  0  3               0x01  0x08
  1  4               0x02  0x10
  2  5               0x04  0x20
  6  7               0x40  0x80
```

**Key implementation details:**
- Rows 0-3, Columns 0-1
- Full cell (all dots) = 0x28FF
- Empty cell = 0x2800

---

### 3. `canvas/canvas.go`

Core Canvas struct and all methods.

**Struct fields:**
```go
type Canvas struct {
    width   int      // pixel width
    height  int      // pixel height
    cells   [][]rune // braille character grid [row][col]
    invertY bool     // Y-axis direction
}
```

**Constructor:**
- `New(width, height int, options ...Option) *Canvas`
- Allocates `cells` as `[Rows()][Cols()]rune`
- Initializes all cells to `BrailleOffset`

**Pixel methods:**
- `Set(x, y float64)` - Set a pixel (OR the bit)
- `Unset(x, y float64)` - Clear a pixel (AND NOT the bit)
- `Toggle(x, y float64)` - Toggle a pixel (XOR the bit)
- `Get(x, y float64) bool` - Check if pixel is set

**Utility methods:**
- `Clear()` - Reset all cells to `BrailleOffset`
- `Frame() string` - Render canvas to string (rows joined by newlines)

**Dimension accessors:**
- `Width() int` - Returns pixel width
- `Height() int` - Returns pixel height
- `Rows() int` - Returns height / 4 (terminal rows)
- `Cols() int` - Returns width / 2 (terminal columns)

**Internal helper:**
- `pixelToCell(x, y float64) (cellRow, cellCol, dotRow, dotCol int, ok bool)`
  - Converts pixel coordinates to cell and dot positions
  - Returns `ok = false` for out-of-bounds coordinates
  - Uses `math.Floor` for float64 to int conversion
  - Handles Y-axis inversion when `invertY` is true

**Key implementation details:**
- All float64 coordinates convert to int using `math.Floor`
- Out-of-bounds coordinates silently ignored (no panic, no error)
- `Frame()` joins rows with `\n`, each row joins cells into a string

---

### 4. `canvas/options.go`

Functional options pattern.

**Contents:**
```go
type Option func(*Canvas)

func WithInvertedY() Option {
    return func(canvas *Canvas) {
        canvas.invertY = true
    }
}
```

---

### 5. `canvas/braille_test.go`

Tests for braille encoding.

**Test cases:**
- `TestPixelMapDot1` through `TestPixelMapDot8` - Each dot position individually
- `TestPixelMapFullCell` - All dots set equals 0x28FF
- `TestPixelMapEmptyCell` - No dots equals 0x2800
- `TestBrailleOffset` - Constant equals 0x2800

**Structure:**
- Table-driven tests for all 8 dot positions
- Verify each position maps to expected bit value

---

### 6. `canvas/canvas_test.go`

Comprehensive canvas tests with visual flag support.

**Test setup:**
```go
var visualFlag = flag.Bool("visual", false, "print visual output")

func TestMain(m *testing.M) {
    flag.Parse()
    os.Exit(m.Run())
}
```

**Test cases:**

| Test Name | Description |
|-----------|-------------|
| `TestNew` | Verify dimensions and initial state (all cells are BrailleOffset) |
| `TestSetGet` | Set a pixel, verify Get returns true |
| `TestUnset` | Set then unset, verify Get returns false |
| `TestToggle` | Toggle twice returns to original state |
| `TestClear` | Set pixels, clear, verify all Get return false |
| `TestFrame` | Set specific pixels, verify exact braille output |
| `TestOutOfBounds` | Setting out-of-bounds coordinates does not panic |
| `TestOutOfBoundsNegative` | Negative coordinates do not panic |
| `TestInvertedY` | Verify Y-axis inversion works correctly |
| `TestDimensions` | Width, Height, Rows, Cols return expected values |
| `TestFrameMultipleRows` | Multi-row canvas renders correctly |

**Visual output helper:**
```go
func printVisual(t *testing.T, name string, canvas *Canvas) {
    if *visualFlag {
        t.Logf("\n=== %s ===\n%s", name, canvas.Frame())
    }
}
```

---

### 7. `examples/demo/main.go`

Demo program showing pixel operations.

**Demonstrations:**
1. Draw individual pixels at known positions
2. Show braille encoding by setting specific dots
3. Draw a simple pattern (e.g., diagonal line of pixels)
4. Display canvas dimensions

**Output format:**
```
brodot v0.1.0 Demo
==================

Canvas: 40x20 pixels (20 cols x 5 rows)

1. Individual pixels:
[rendered output]

2. All 8 dots in a cell:
[rendered output]

3. Diagonal pattern:
[rendered output]
```

---

## Implementation Order

Execute in this sequence to enable incremental testing:

1. **`go.mod`** - Initialize module with `github.com/cboone/brodot`
2. **Update `README.md`** - Change import paths from `github.com/brodot/brodot` to `github.com/cboone/brodot`
3. **`canvas/braille.go`** - Constants (no dependencies)
4. **`canvas/options.go`** - Options type (no dependencies)
5. **`canvas/canvas.go`** - Core implementation (depends on braille.go, options.go)
6. **`canvas/braille_test.go`** - Test braille encoding
7. **`canvas/canvas_test.go`** - Test canvas operations
8. **`examples/demo/main.go`** - Visual demonstration

---

## Verification Steps

After implementation, run these commands to verify:

```bash
# Run all tests
go test ./canvas/...

# Run tests with visual output
go test ./canvas/... -v -args -visual

# Run demo program
go run ./examples/demo/

# Verify no build errors
go build ./...
```

---

## Key Design Decisions

### Coordinate Conversion
- Use `math.Floor` (not rounding) for consistent behavior
- Pixel (0.0, 0.0) maps to top-left of canvas
- Pixel (0.9, 0.9) still maps to cell (0, 0), dot (0, 0)

### Out-of-Bounds Handling
- Silent ignore for all operations (Set, Unset, Toggle)
- Get returns `false` for out-of-bounds
- Enables partial rendering of shapes that extend beyond canvas

### Cell Storage
- Row-major order: `cells[row][col]`
- Direct rune storage (not byte) for Unicode compatibility
- Each cell initialized to BrailleOffset (empty pattern)

### Y-Axis Inversion
- Default: Y increases downward (standard screen coordinates)
- With `WithInvertedY()`: Y increases upward (mathematical coordinates)
- Useful for Maze Wars which may use mathematical coordinate system

---

## Expected Test Output (with -visual flag)

```
=== TestSetGet ===
⠁

=== TestFrame ===
⠁⠈
⠂⠐

=== TestInvertedY ===
⠠⠄
⠂⠐
```

---

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| `go.mod` | Create | Module definition (`github.com/cboone/brodot`) |
| `README.md` | Update | Fix import paths to `github.com/cboone/brodot` |
| `canvas/braille.go` | Create | Braille constants |
| `canvas/options.go` | Create | Functional options |
| `canvas/canvas.go` | Create | Core implementation |
| `canvas/braille_test.go` | Create | Braille tests |
| `canvas/canvas_test.go` | Create | Canvas tests |
| `examples/demo/main.go` | Create | Demo program |

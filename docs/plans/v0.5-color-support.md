# brodot v0.5.0 Implementation Plan: Color Support

Add optional per-cell ANSI color support for visual distinction.

---

## Files to Change

| File | Action | Description |
|------|--------|-------------|
| `canvas/color.go` | CREATE | Color type, constants, ANSI methods |
| `canvas/canvas.go` | MODIFY | Add color fields, SetColor method, update Frame() |
| `canvas/options.go` | MODIFY | Add WithColor() option |
| `canvas/color_test.go` | CREATE | Color tests with visual flag support |
| `examples/demo/main.go` | MODIFY | Add color demonstrations (Demos 21-24) |

---

## Implementation Details

### 1. Create `canvas/color.go`

```go
package canvas

// Color represents an ANSI foreground color.
type Color uint8

// Standard ANSI foreground colors (alphabetical except ColorDefault at 0).
const (
    ColorDefault Color = iota
    ColorBlack
    ColorBlue
    ColorCyan
    ColorGreen
    ColorMagenta
    ColorRed
    ColorWhite
    ColorYellow
)

// ansiCodes maps Color values to ANSI escape sequences.
var ansiCodes = [...]string{
    ColorDefault: "",
    ColorBlack:   "\x1b[30m",
    ColorBlue:    "\x1b[34m",
    ColorCyan:    "\x1b[36m",
    ColorGreen:   "\x1b[32m",
    ColorMagenta: "\x1b[35m",
    ColorRed:     "\x1b[31m",
    ColorWhite:   "\x1b[37m",
    ColorYellow:  "\x1b[33m",
}

// ANSI returns the ANSI escape sequence for this color.
func (color Color) ANSI() string {
    if int(color) >= len(ansiCodes) {
        return ""
    }
    return ansiCodes[color]
}

// ANSIReset returns the ANSI reset escape sequence.
func ANSIReset() string {
    return "\x1b[0m"
}
```

### 2. Modify `canvas/canvas.go`

**Add struct fields:**
```go
type Canvas struct {
    cells        [][]rune
    colorEnabled bool
    colors       [][]Color  // nil when colors disabled
    height       int
    invertY      bool
    width        int
}
```

**Add SetColor method:**
```go
// SetColor sets the pixel at the specified coordinates and assigns the given color
// to the containing cell. Without WithColor(), the pixel is set but color is ignored.
func (canvas *Canvas) SetColor(x, y float64, color Color) {
    cellRow, cellColumn, dotRow, dotColumn, ok := canvas.pixelToCell(x, y)
    if !ok {
        return
    }
    canvas.cells[cellRow][cellColumn] |= pixelMap[dotRow][dotColumn]
    if canvas.colors != nil {
        canvas.colors[cellRow][cellColumn] = color
    }
}
```

**Update New() to allocate colors grid when enabled:**
```go
// After existing cells allocation:
if canvas.colorEnabled {
    canvas.colors = make([][]Color, rows)
    for row := range canvas.colors {
        canvas.colors[row] = make([]Color, columns)
    }
}
```

**Update Clear() to reset colors:**
```go
if canvas.colors != nil {
    for row := range canvas.colors {
        for column := range canvas.colors[row] {
            canvas.colors[row][column] = ColorDefault
        }
    }
}
```

**Update Frame() with color rendering:**
```go
func (canvas *Canvas) Frame() string {
    if !canvas.colorEnabled {
        // Fast path: no colors (existing implementation)
        rows := make([]string, len(canvas.cells))
        for index, row := range canvas.cells {
            rows[index] = string(row)
        }
        return strings.Join(rows, "\n")
    }

    // Color-enabled path
    var builder strings.Builder
    for rowIndex, row := range canvas.cells {
        if rowIndex > 0 {
            builder.WriteByte('\n')
        }
        for columnIndex, cell := range row {
            color := canvas.colors[rowIndex][columnIndex]
            if color != ColorDefault {
                builder.WriteString(color.ANSI())
                builder.WriteRune(cell)
                builder.WriteString(ANSIReset())
            } else {
                builder.WriteRune(cell)
            }
        }
    }
    return builder.String()
}
```

### 3. Modify `canvas/options.go`

Add WithColor option (alphabetically before WithInvertedY):

```go
// WithColor returns an option that enables per-cell ANSI color support.
func WithColor() Option {
    return func(canvas *Canvas) {
        canvas.colorEnabled = true
    }
}
```

### 4. Create `canvas/color_test.go`

Tests to implement:
- `TestColorANSI` - Each color produces correct escape sequence
- `TestColorANSIOutOfBounds` - Invalid color returns empty string
- `TestANSIReset` - Reset sequence is correct
- `TestSetColorWithColorEnabled` - Sets pixel AND stores color
- `TestSetColorWithoutColorEnabled` - Sets pixel, ignores color
- `TestColorLastWriteWins` - Multiple pixels in same cell, last color wins
- `TestColorReset` - Each colored cell has reset after it
- `TestColorClear` - Clear() resets both pixels and colors
- `TestColorOutOfBounds` - Out-of-bounds SetColor doesn't panic
- `TestFrameWithMixedColors` - Frame contains correct codes
- `TestFrameNoColorsWhenDisabled` - No escape codes without WithColor()
- `TestWithColorAndWithInvertedY` - Both options work together
- `TestColorDefaultNotRendered` - ColorDefault emits no codes

### 5. Update `examples/demo/main.go`

Update version banner to v0.5.0 and add:

- **Demo 21: Color basics** - Vertical bars of each color
- **Demo 22: Colored lines** - Red horizontal, green diagonal, blue vertical
- **Demo 23: Colored rectangles** - Cyan outer, yellow inner nested rectangles
- **Demo 24: Colored eyeball** - White eye, blue iris, black pupil

Add `"math"` import for colored eyeball demo.

---

## ANSI Color Reference

| Color | Constant | Code | Escape |
|-------|----------|------|--------|
| Default | `ColorDefault` | - | (none) |
| Black | `ColorBlack` | 30 | `\x1b[30m` |
| Red | `ColorRed` | 31 | `\x1b[31m` |
| Green | `ColorGreen` | 32 | `\x1b[32m` |
| Yellow | `ColorYellow` | 33 | `\x1b[33m` |
| Blue | `ColorBlue` | 34 | `\x1b[34m` |
| Magenta | `ColorMagenta` | 35 | `\x1b[35m` |
| Cyan | `ColorCyan` | 36 | `\x1b[36m` |
| White | `ColorWhite` | 37 | `\x1b[37m` |
| Reset | `ANSIReset()` | 0 | `\x1b[0m` |

---

## Design Decisions

1. **Memory efficiency**: Color grid only allocated when WithColor() used
2. **Backwards compatible**: Existing code works unchanged
3. **Per-cell coloring**: Matches braille character granularity
4. **Last-write-wins**: Multiple SetColor calls to same cell, last color wins
5. **Reset per cell**: Each colored cell emits reset to prevent bleeding
6. **Fast path**: Frame() has separate branch for non-color canvases

---

## Implementation Sequence

1. Create `canvas/color.go` with Color type and ANSI methods
2. Modify `canvas/canvas.go`:
   - Add colorEnabled and colors fields to struct
   - Add SetColor() method
   - Update New() for colors allocation
   - Update Clear() for colors reset
   - Update Frame() with color rendering
3. Modify `canvas/options.go` with WithColor()
4. Create `canvas/color_test.go` with all tests
5. Update `examples/demo/main.go` with color demos
6. Run full test suite and visual verification

---

## Verification

```bash
# Run all tests
go test ./...

# Visual verification of tests
go test ./canvas/... -v -args -visual

# Run demo program
go run ./examples/demo/
```

---

## Checklist (for PLAN.md)

After implementation, update `docs/plans/PLAN.md` v0.5.0 deliverables:
- [ ] `canvas/color.go`
- [ ] Updated `canvas/canvas.go` with color support
- [ ] Updated `canvas/options.go` with `WithColor()`
- [ ] `canvas/color_test.go` with `-visual` flag support
- [ ] Update `examples/demo/main.go` with color demonstrations
